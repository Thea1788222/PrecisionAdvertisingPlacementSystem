<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>广告追踪SDK测试页面</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .test-section h2 {
            margin-top: 0;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        #result {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin-top: 20px;
            white-space: pre-wrap;
        }
        .ad-container {
            border: 2px dashed #007bff;
            padding: 20px;
            text-align: center;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <h1>广告追踪SDK功能测试</h1>
    
    <div class="test-section">
        <h2>1. SDK初始化</h2>
        <button onclick="initSDK()">初始化SDK</button>
        <button onclick="initSDKWithDomain()">初始化SDK(带域名)</button>
        <p>点击按钮初始化广告追踪SDK，配置追踪服务器地址和网站标识。</p>
    </div>
    
    <div class="test-section">
        <h2>2. 用户行为追踪</h2>
        <button onclick="trackPageView()">记录页面浏览</button>
        <button onclick="trackClick()">记录点击事件</button>
        <p>模拟用户在页面上的行为，包括浏览页面和点击按钮。</p>
    </div>
    
    <div class="test-section">
        <h2>3. 广告交互追踪</h2>
        <div class="ad-container">
            <h3>测试广告位</h3>
            <p>这是一个模拟的广告位，用于测试广告展示和点击追踪。</p>
            <button onclick="trackAdImpression()">记录广告展示</button>
            <button onclick="trackAdClick()">记录广告点击</button>
        </div>
    </div>
    
    <div class="test-section">
        <h2>4. 广告推荐</h2>
        <button onclick="getRecommendedAds()">获取推荐广告</button>
        <p>根据用户画像获取个性化推荐广告。</p>
        <div id="recommended-ads"></div>
    </div>
    
    <div class="test-section">
        <h2>5. 用户标识信息</h2>
        <button onclick="showUserInfo()">显示用户标识信息</button>
        <p>显示当前用户的Cookie ID和浏览器指纹信息。</p>
    </div>
    
    <div class="test-section">
        <h2>6. 自动化测试</h2>
        <button onclick="runAutomatedTests()">运行自动化测试</button>
        <p>运行完整的SDK功能测试套件。</p>
    </div>
    
    <div id="result"></div>

    <!-- 引入广告追踪SDK -->
    <script src="ad-tracker.js"></script>
    <script src="sdk-test.js"></script>
    
    <script>
        // 显示结果的辅助函数
        function showResult(message) {
            document.getElementById('result').textContent = message;
        }
        
        // 显示推荐广告的辅助函数
        function showRecommendedAds(ads) {
            const container = document.getElementById('recommended-ads');
            container.innerHTML = '<h3>推荐广告:</h3>';
            
            if (ads && ads.length > 0) {
                const ul = document.createElement('ul');
                ads.forEach(ad => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <strong>${ad.title}</strong> (${ad.type})<br>
                        出价: ${ad.bidPrice}<br>
                        <a href="${ad.linkUrl}" target="_blank">查看详情</a>
                    `;
                    ul.appendChild(li);
                });
                container.appendChild(ul);
            } else {
                container.innerHTML += '<p>暂无推荐广告</p>';
            }
        }
        
        // 1. 初始化SDK
        function initSDK() {
            try {
                adTracker.init({
                    trackerServer: 'http://localhost:8084',
                    website: 'test-website'
                });
                showResult('SDK初始化成功!\n' +
                          '追踪服务器: http://localhost:8084\n' +
                          '网站标识: test-website\n' +
                          'Cookie ID: ' + adTracker.config.cookieId);
            } catch (error) {
                showResult('SDK初始化失败: ' + error.message);
            }
        }
        
        // 1.1 初始化SDK(带域名)
        function initSDKWithDomain() {
            try {
                adTracker.init({
                    trackerServer: 'http://track.local:8084',
                    website: 'test-website',
                    domain: '.local'
                });
                showResult('SDK初始化成功!\n' +
                          '追踪服务器: http://track.local:8084\n' +
                          '网站标识: test-website\n' +
                          'Cookie域: .local\n' +
                          'Cookie ID: ' + adTracker.config.cookieId);
            } catch (error) {
                showResult('SDK初始化失败: ' + error.message);
            }
        }
        
        // 2. 记录页面浏览
        function trackPageView() {
            try {
                adTracker.trackPageView({
                    targetId: 'test-page',
                    category: 'test-category',
                    keywords: 'test, sdk'
                });
                showResult('页面浏览记录成功!');
            } catch (error) {
                showResult('页面浏览记录失败: ' + error.message);
            }
        }
        
        // 3. 记录点击事件
        function trackClick() {
            try {
                adTracker.trackClick({
                    targetId: 'test-button',
                    category: 'test-category'
                });
                showResult('点击事件记录成功!');
            } catch (error) {
                showResult('点击事件记录失败: ' + error.message);
            }
        }
        
        // 4. 记录广告展示
        function trackAdImpression() {
            try {
                // 使用测试数据中的广告ID
                adTracker.trackAdImpression(1, 'top-banner', 1.50);
                showResult('广告展示记录成功!\n广告ID: 1\n位置: top-banner\n出价: 1.50');
            } catch (error) {
                showResult('广告展示记录失败: ' + error.message);
            }
        }
        
        // 5. 记录广告点击
        function trackAdClick() {
            try {
                // 使用测试数据中的展示ID
                adTracker.trackAdClick(1);
                showResult('广告点击记录成功!\n展示ID: 1');
            } catch (error) {
                showResult('广告点击记录失败: ' + error.message);
            }
        }
        
        // 6. 获取推荐广告
        function getRecommendedAds() {
            try {
                adTracker.getRecommendedAds({
                    positions: ['top-banner', 'sidebar'],
                    category: 'electronics',
                    count: 3
                }).then(ads => {
                    showResult('推荐广告获取成功!');
                    showRecommendedAds(ads);
                }).catch(error => {
                    showResult('推荐广告获取失败: ' + error.message);
                });
            } catch (error) {
                showResult('推荐广告获取失败: ' + error.message);
            }
        }
        
        // 7. 显示用户信息
        function showUserInfo() {
            try {
                const fingerprint = adTracker.generateFingerprint();
                showResult('用户标识信息:\n' +
                          'Cookie ID: ' + adTracker.config.cookieId + '\n' +
                          '浏览器指纹: ' + fingerprint);
            } catch (error) {
                showResult('获取用户信息失败: ' + error.message);
            }
        }
        
        // 8. 运行自动化测试
        function runAutomatedTests() {
            try {
                // 清空结果区域
                showResult('正在运行自动化测试...');
                
                // 运行测试套件
                setTimeout(async () => {
                    if (typeof testSuite !== 'undefined') {
                        await testSuite.run();
                        showResult('自动化测试完成，请查看浏览器控制台获取详细结果。');
                    } else {
                        showResult('错误：测试套件未定义，请确保sdk-test.js已正确加载。');
                    }
                }, 1000);
            } catch (error) {
                showResult('运行自动化测试失败: ' + error.message);
            }
        }
    </script>
</body>
</html>